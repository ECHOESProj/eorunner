# EoRunner

## Overview
EoRunner is an application which interacts with the [ECHOES Earth Observation Processing Service](https://github.com/ECHOESProj/eo-docs) and saves the resulting GeoTIFF imagery onto GeoServer, which is then viewable on the ECHOES web platform.

EoRunner gets sites from the web application database, groups close sites together and combines them into a regular grid called areas of interest (AOI). For each AOI, for each date within each EO process defined in `eom_processes.py` (ndvi, ndwi, ndmi, etc.), it will call the Earth Observation Processing Service via websockets (passing in the AOI polygon, start/end date and EO process name). Each individual call to the EO Service will generate a single GeoTIFF for single AOI, for a particular EO process, for a particular date. This GeoTIFF is then submitted to GeoServer via REST API. If the GeoServer workspace/store/layer does not exist, it will be automatically generated by the application.

EoRunner supports running EO processes at daily, monthly, yearly and custom date interval frequency.

EoRunner will cross reference imagery already stored on GeoServer so it doesn't re-generate imagery already captured.

<br>

## Project structure
This project uses a Python virtual environment which is stored locally in `.venv`. A package structure is used so that top level scripts (e.g. app.py) and second level scripts (e.g. utils/fs.py) can be run individually and can import each other easily.
`init.py` contains a `get_env` function that will retrive the value of an environment variable (defined in the `config` folder using `dotenv`). It also has a `get_path` function which will resolve paths relative to the project root.

The config folder contains `.env` files which contain settings for each environment, along with a `base.env` to store common settings. All settings defined in the `.env` files can be overridden with container / system environment variables.
A file called `overrides.env` can be added to the config folder and can contain settings for local development. This file can contain usernames and passwords and is ignored by source control so never gets checked in.

<br>

## Install
* Install Python 3.6 for Windows `https://www.python.org/ftp/python/3.6.5/python-3.6.5-amd64.exe`
* Run powershell script `.\setup.ps1`

<br>

## Manual installation steps - only needed if something goes wrong with setup.ps1
* Create virtual environment in the solution folder `py -3.6 -m venv .venv`
* Activate environment
  * Using CMD run `.\.venv\Scripts\Activate.bat`
  * Using Powershell run `& .\.venv\Scripts\Activate.ps1`
  * Using VS Code + Python extension - Enable environment for workspace - F1 - Python: Create Terminal )
* Update pip `python -m pip install --upgrade pip`
* Run pip install to restore dependencies `pip install -r requirements.txt`

<br>

## Update config
Before running the application, ensure that relevant credentials and endpoints are set in `base.env` or `dev/qa/production.env` in the `app/config` folder.
Values can also be set in `overrides.env` for local testing.

## Run with powershell
`.\tasks\run.ps1 eom --env=dev`

The above processes accept start and end date, module(s) and backdate option. If backdate is true, then start and end dates are taken from instrument config, e.g.

```bash
.\tasks\run.ps1 eom --env=dev --start=2019-05-01 --end=2019-06-01
.\tasks\run.ps1 eom --env=dev --start=2019-05-01 --end=2019-06-01 --module=true_color
.\tasks\run.ps1 eom --env=dev --backdate --module=true_color --module=ndvi
```
<br>

## Run in virtual environment
After activating the virtual environment, same as above, except replace `.\tasks\run.ps1` with `python -m app`, e.g:
`python -m app eom --env=dev`

<br>

## Running in Production
EoRunner should run on a daily schedule (1am) with the `backdate` flag so that existing sites get the newest EO imagery available, and new sites get EO imagery from 1985 to present.

The EO processes are divided into two groups and are run in parallel using `tasks/batch1.ps1` and `tasks/batch2.ps1`. Two Windows scheduled tasks are created to run `batch1` and 1am, and `batch2` at 1:20am. The action for each scheduled task is `Start a program` with the following settings

* Program/script: `Powershell.exe`
* Add arguments: `-File tasks/batch1.ps1 eom --env=production`
* Start in: `D:\eo-runner-production`

For the `batch2` task, replace `batch1.ps1` with `batch2.ps1`

`tasks/batch1.ps1` and `tasks/batch2.ps1` can be adapted for a unix system and task run with Cron.

<br>

## Older modules
eom is the primary module in use. There are previously developed modules, eo and eom_region which have
not been maintained, may not currently work, and might be removed in future
